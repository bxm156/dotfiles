#!/usr/bin/env bash
set -euo pipefail

SCRIPTS_DIR="$HOME/.local/scripts"

# Check if gum is available
if ! command -v gum >/dev/null 2>&1; then
    echo "Error: gum is required but not found. Please ensure gum is installed."
    exit 1
fi

# Check if scripts directory exists
if [[ ! -d "$SCRIPTS_DIR" ]]; then
    gum style --foreground 1 "No scripts directory found."
    echo "Create ~/.local/scripts/ and add executable scripts."
    exit 0
fi

# Discover executable scripts in the directory
discover_scripts() {
    local scripts=()

    # Find all executable files (not directories)
    while IFS= read -r -d '' file; do
        # Skip hidden files
        [[ "$(basename "$file")" == .* ]] && continue

        # Skip non-script extensions
        case "${file##*.}" in
            md|txt|json|yaml|yml) continue ;;
        esac

        scripts+=("$file")
    done < <(find "$SCRIPTS_DIR" -maxdepth 1 -type f -executable -print0 2>/dev/null || true)

    printf '%s\n' "${scripts[@]}"
}

# Get display name from script (parse NAME: header or convert filename)
get_display_name() {
    local file="$1"
    local name=""

    # Try to find "# NAME: ..." in first 10 lines
    name=$(head -n 10 "$file" 2>/dev/null | grep -m 1 "^#[[:space:]]*NAME:" | sed 's/^#[[:space:]]*NAME:[[:space:]]*//' || true)

    # Fallback: convert filename to title case
    if [[ -z "$name" ]]; then
        local basename_file
        basename_file=$(basename "$file")
        # Remove extension, replace dashes/underscores with spaces, capitalize first letter of each word
        name=$(echo "$basename_file" | sed -e 's/\.[^.]*$//' -e 's/[-_]/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
    fi

    echo "$name"
}

# Build menu options
build_menu_options() {
    local scripts
    mapfile -t scripts < <(discover_scripts)

    if [[ ${#scripts[@]} -eq 0 ]]; then
        gum style --foreground 3 "No executable scripts found in ~/.local/scripts/"
        echo ""
        echo "Add scripts with '# NAME: Description' header and make them executable (chmod +x)"
        exit 0
    fi

    local options=()
    for script in "${scripts[@]}"; do
        local display_name
        local filename
        display_name=$(get_display_name "$script")
        filename=$(basename "$script")
        options+=("$display_name ($filename)|$script")
    done

    printf '%s\n' "${options[@]}"
}

# Execute selected script
execute_script() {
    local script_path="$1"
    local display_name="$2"

    # Verify script is still executable
    if [[ ! -x "$script_path" ]]; then
        gum style --foreground 1 "✗ Error: Script is not executable"
        sleep 2
        return
    fi

    clear
    gum style --bold --border normal --padding "1 2" "Running: $display_name"
    echo ""

    # Execute script and capture exit code
    local exit_code=0
    "$script_path" || exit_code=$?

    echo ""

    # Show status based on exit code
    if [[ $exit_code -eq 0 ]]; then
        gum style --foreground 2 "✓ Script completed successfully"
    else
        gum style --foreground 1 "✗ Script failed (exit code: $exit_code)"
    fi

    sleep 2
}

# Main loop
main() {
    while true; do
        clear

        # Show header
        gum style --bold --border normal --padding "1 2" "Starship Scripts"
        echo ""

        # Build menu options
        local menu_items
        mapfile -t menu_items < <(build_menu_options)
        menu_items+=("Exit|EXIT")

        # Extract display parts for gum choose
        local display_options=()
        for item in "${menu_items[@]}"; do
            display_options+=("${item%%|*}")
        done

        # Show menu and get selection
        local selection
        selection=$(printf '%s\n' "${display_options[@]}" | gum choose --height 15) || {
            # User pressed Escape or Ctrl+C
            clear
            exit 0
        }

        # Handle selection
        if [[ "$selection" == "Exit" ]]; then
            clear
            exit 0
        fi

        # Find the corresponding script path
        for item in "${menu_items[@]}"; do
            if [[ "${item%%|*}" == "$selection" ]]; then
                local script_path="${item##*|}"
                execute_script "$script_path" "$selection"
                break
            fi
        done
    done
}

main
