[tools]
node = "24"
claude = "latest"
chezmoi = "latest"
bats = "latest"
"npm:bats-support" = "latest"
"npm:bats-assert" = "latest"

[env]
# Use native architecture for Docker test containers
# Detects ARM64 on Apple Silicon, AMD64 on Intel/AMD
DOCKER_PLATFORM = "linux/{{exec(command='chezmoi data | jq -r .chezmoi.arch')}}"

[tasks.dotfiles]
description = "Install dotfiles"
run = "curl -fsLS https://raw.githubusercontent.com/bxm156/dotfiles/main/install.sh | bash"

[tasks.test]
description = "Test dotfiles in isolated container"
run = "docker compose run --rm dotfiles-test"

[tasks."test:interactive"]
description = "Run tests and open interactive shell (dotfiles installed)"
run = "docker compose run --rm dotfiles-test"

[tasks."test:shell"]
description = "Open shell WITHOUT installing dotfiles (for debugging)"
run = "docker compose run --rm --entrypoint bash dotfiles-test"

[tasks."test:github"]
description = "Test dotfiles by pulling from GitHub (simulates real installation)"
run = "docker compose run --rm dotfiles-test-github"

[tasks."test:github:interactive"]
description = "Run GitHub test and open interactive shell"
run = "docker compose run --rm dotfiles-test-github"

[tasks."test:render"]
description = "Test template rendering and syntax validation"
run = "tests/test-render-simple.sh"

[tasks."test:logging"]
description = "Test logging helper library"
run = "bash tests/test-logging-helpers.sh"

[tasks."test:install"]
description = "Test install.sh script in test container (pretty mode)"
run = """
docker compose run --rm \
  --entrypoint bash \
  -v $(pwd)/install.sh:/tmp/install.sh:ro \
  dotfiles-test \
  /tmp/install.sh
"""

[tasks."test:install:safe"]
description = "Test install.sh --safe mode in test container"
run = """
docker compose run --rm \
  --entrypoint bash \
  -v $(pwd)/install.sh:/tmp/install.sh:ro \
  dotfiles-test \
  /tmp/install.sh --safe
"""

[tasks."test:install:bootstrap"]
description = "Test install.sh with custom bootstrap path"
run = """
docker compose run --rm \
  --entrypoint bash \
  -v $(pwd)/install.sh:/tmp/install.sh:ro \
  dotfiles-test \
  /tmp/install.sh --bootstrap /home/user/.local/bin
"""

[tasks."test:bats"]
description = "Run all bats tests (requires dotfiles to be installed)"
run = "bats tests/{syntax,binaries,integration,install,meta}/*.bats tests/unit.bats"

[tasks."test:bats:syntax"]
description = "Run bats syntax tests"
run = "bats tests/syntax/*.bats"

[tasks."test:bats:unit"]
description = "Run bats unit tests"
run = "bats tests/unit.bats"

[tasks."test:bats:binaries"]
description = "Run bats binary verification tests"
run = "bats tests/binaries/*.bats"

[tasks."test:bats:integration"]
description = "Run bats integration tests"
run = "bats tests/integration/*.bats"

[tasks."test:bats:install"]
description = "Run bats install.sh tests"
run = "bats tests/install/*.bats"

[tasks."test:bats:meta"]
description = "Run test suite integrity tests"
run = "bats tests/meta/*.bats"

[tasks."test:ci"]
description = "Run all CI tests (fast tests only, no network dependencies)"
run = """
bats tests/syntax/templates.bats tests/syntax/scripts.bats tests/unit.bats tests/install/*.bats tests/meta/*.bats
"""

[tasks."test:ci:full"]
description = "Run all CI tests including network-dependent tests"
run = """
bats tests/syntax/*.bats tests/unit.bats tests/install/*.bats tests/meta/*.bats
"""

[tasks.clean]
description = "Clean up Docker containers and volumes"
run = "docker compose down --volumes --remove-orphans"

[tasks."clean:full"]
description = "Clean up everything including images and build cache (forces rebuild)"
run = "docker compose down --volumes --remove-orphans --rmi all && docker builder prune -af"
