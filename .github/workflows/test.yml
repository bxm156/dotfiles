name: Test Dotfiles

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  # GitHub username for dotfiles repository
  # If you fork this repo, change this to your username
  DOTFILES_USER: bxm156

jobs:
  # Syntax and unit tests that don't require full installation
  quick-tests:
    name: Quick Tests (Syntax & Unit)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run syntax tests
        run: tests/libs/bats-core/bin/bats tests/syntax/*.bats

      - name: Run unit tests
        run: tests/libs/bats-core/bin/bats tests/unit.bats

      - name: Run install.sh validation tests
        run: tests/libs/bats-core/bin/bats tests/install/*.bats

  # Full integration tests with Docker (Linux amd64)
  integration-linux-amd64:
    name: Integration Tests (Linux amd64)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test container
        run: docker compose build dotfiles-test
        env:
          DOCKER_PLATFORM: linux/amd64

      - name: Apply dotfiles and run bats integration tests
        timeout-minutes: 20
        run: |
          docker compose run --rm \
            --entrypoint /bin/bash \
            dotfiles-test \
            -c "
              set -euo pipefail
              # Install chezmoi and apply dotfiles
              mkdir -p ~/.local/bin
              sh -c \"\$(curl -fsLS get.chezmoi.io/lb)\" -- init --apply --source ~/.local/share/chezmoi
              # Run bats integration and binary tests
              tests/libs/bats-core/bin/bats /home/user/.local/share/chezmoi/tests/integration/*.bats
              tests/libs/bats-core/bin/bats /home/user/.local/share/chezmoi/tests/binaries/*.bats
            "
        env:
          DOCKER_PLATFORM: linux/amd64

  # Full integration tests with Docker (Linux arm64)
  integration-linux-arm64:
    name: Integration Tests (Linux arm64)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # ARM64 emulation is slow, only run on main branch
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test container
        run: docker compose build dotfiles-test
        env:
          DOCKER_PLATFORM: linux/arm64

      - name: Apply dotfiles and run bats integration tests
        timeout-minutes: 30
        run: |
          docker compose run --rm \
            --entrypoint /bin/bash \
            dotfiles-test \
            -c "
              set -euo pipefail
              # Install chezmoi and apply dotfiles
              mkdir -p ~/.local/bin
              sh -c \"\$(curl -fsLS get.chezmoi.io/lb)\" -- init --apply --source ~/.local/share/chezmoi
              # Run bats integration and binary tests
              tests/libs/bats-core/bin/bats /home/user/.local/share/chezmoi/tests/integration/*.bats
              tests/libs/bats-core/bin/bats /home/user/.local/share/chezmoi/tests/binaries/*.bats
            "
        env:
          DOCKER_PLATFORM: linux/arm64

  # macOS tests (amd64)
  macos-amd64:
    name: macOS Tests (Intel)
    runs-on: macos-13  # Intel runner
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run syntax tests
        run: tests/libs/bats-core/bin/bats tests/syntax/*.bats

      - name: Run unit tests
        run: tests/libs/bats-core/bin/bats tests/unit.bats

      - name: Apply dotfiles
        timeout-minutes: 15
        run: |
          $HOME/.local/bin/chezmoi init --apply ${{ env.DOTFILES_USER }}

      - name: Run integration tests
        run: tests/libs/bats-core/bin/bats tests/integration/*.bats

      - name: Run binary tests
        run: tests/libs/bats-core/bin/bats tests/binaries/*.bats

  # macOS tests (arm64)
  macos-arm64:
    name: macOS Tests (Apple Silicon)
    runs-on: macos-latest  # M1 runner
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run syntax tests
        run: tests/libs/bats-core/bin/bats tests/syntax/*.bats

      - name: Run unit tests
        run: tests/libs/bats-core/bin/bats tests/unit.bats

      - name: Apply dotfiles
        timeout-minutes: 15
        run: |
          $HOME/.local/bin/chezmoi init --apply ${{ env.DOTFILES_USER }}

      - name: Run integration tests
        run: tests/libs/bats-core/bin/bats tests/integration/*.bats

      - name: Run binary tests
        run: tests/libs/bats-core/bin/bats tests/binaries/*.bats

  # Test install.sh variations
  test-installer:
    name: Test install.sh (${{ matrix.mode }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        mode:
          - default
          - safe
          - bootstrap

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test container
        run: docker compose build dotfiles-test
        env:
          DOCKER_PLATFORM: linux/amd64

      - name: Test install.sh (default mode)
        if: matrix.mode == 'default'
        timeout-minutes: 15
        run: |
          docker compose run --rm \
            --entrypoint bash \
            -v $(pwd)/install.sh:/tmp/install.sh:ro \
            dotfiles-test \
            /tmp/install.sh
        env:
          DOCKER_PLATFORM: linux/amd64

      - name: Test install.sh (safe mode)
        if: matrix.mode == 'safe'
        timeout-minutes: 15
        run: |
          docker compose run --rm \
            --entrypoint bash \
            -v $(pwd)/install.sh:/tmp/install.sh:ro \
            dotfiles-test \
            /tmp/install.sh --safe
        env:
          DOCKER_PLATFORM: linux/amd64

      - name: Test install.sh (bootstrap mode)
        if: matrix.mode == 'bootstrap'
        timeout-minutes: 15
        run: |
          docker compose run --rm \
            --entrypoint bash \
            -v $(pwd)/install.sh:/tmp/install.sh:ro \
            dotfiles-test \
            /tmp/install.sh --bootstrap /home/user/.local/bin
        env:
          DOCKER_PLATFORM: linux/amd64
