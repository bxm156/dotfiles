#!/usr/bin/env bash
set -euo pipefail

# Verify external binary installations and log results
# This runs after .chezmoiexternal.toml.tmpl downloads binaries

# Source logging helpers (from chezmoi source directory or current directory)
if [[ -f ~/.local/share/chezmoi/.chezmoiscripts/lib/.logging.sh ]]; then
    source ~/.local/share/chezmoi/.chezmoiscripts/lib/.logging.sh
elif [[ -f "$(dirname "${BASH_SOURCE[0]}")/lib/.logging.sh" ]]; then
    source "$(dirname "${BASH_SOURCE[0]}")/lib/.logging.sh"
else
    echo "Error: Could not find logging helpers" >&2
    exit 1
fi

log_section "External Binary Verification"

# List of binaries from .chezmoiexternal.toml.tmpl
binaries=(
    "jq"
    "fzf"
    "zoxide"
    "bat"
    "gitui"
    "gum"
    "glow"
    "mods"
    "freeze"
    "vhs"
    "asciinema"
    "rumdl"
)

# taskwarrior-tui only available on x86_64
{{- if eq .chezmoi.arch "amd64" }}
binaries+=("taskwarrior-tui")
{{- end }}

failed=0

for binary in "${binaries[@]}"; do
    binary_path="$HOME/.local/bin/$binary"

    if [[ ! -e "$binary_path" ]]; then
        log_error "${binary}: not found at ${binary_path}"
        failed=1
        continue
    fi

    if [[ ! -f "$binary_path" ]]; then
        log_error "${binary}: exists but is not a regular file"
        failed=1
        continue
    fi

    if [[ ! -x "$binary_path" ]]; then
        log_error "${binary}: is not executable"
        failed=1
        continue
    fi

    log_success "${binary}: installed and verified"
done

if [[ $failed -eq 1 ]]; then
    log_error "Some binary installations failed"
    exit 1
fi

log_success "All external binaries verified successfully"
