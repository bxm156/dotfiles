#!/usr/bin/env bash
set -euo pipefail

# Merge MCP servers from template into ~/.claude.json
# Existing servers take precedence over template servers

# Path to target file
claude_json="$HOME/.claude.json"

# Use jq installed by chezmoi external (run_after_ ensures it's available)
jq_bin="$HOME/.local/bin/jq"

# Render MCP servers from template data
mcp_template='{{ includeTemplate "data/mcp.json.tmpl" . }}'

# Create file with empty structure if it doesn't exist
if [[ ! -f "$claude_json" ]]; then
    echo "Creating $claude_json with MCP servers from template"
    echo '{"mcpServers":{}}' > "$claude_json"
fi

# Merge MCP servers: template servers + existing servers (existing wins on conflict)
# The + operator in jq merges objects with the right side taking precedence
temp_file="${claude_json}.tmp"

"$jq_bin" -s '
  .[0] as $existing |
  .[1] as $template |

  # Merge: template servers first, then overlay existing (existing wins)
  $existing + {
    mcpServers: ($template.mcpServers + ($existing.mcpServers // {}))
  }
' "$claude_json" <(echo "$mcp_template") > "$temp_file"

# Replace original file
mv "$temp_file" "$claude_json"

echo "MCP servers merged into $claude_json"
